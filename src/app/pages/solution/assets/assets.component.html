<asset-details *ngIf="selectedAsset && selectedAsset.data"
	[asset]="selectedAsset.data"
	[element]="selectedAsset.element"
	[serialNumber]="selectedAsset.data.serialNumber"
	(close)="onPanelClose()">
</asset-details>

<div class="panel">
	<cui-alert [options]="alert"></cui-alert>
	<cui-tabs inline="true">
		<cui-tab [label]="'_Assets_' | i18n | uppercase">
			<div class="divider no-margin-top qtr-margin-bottom"></div>
			<ng-container *ngTemplateOutlet="assetsContent"></ng-container>
		</cui-tab>
		<ng-template cuiTabPost>
			<div class="text-right">
				<div *ngIf="!status.isLoading && pagination"
					(click)="filterCollapse = !filterCollapse"
					data-auto-id="VisualFilterCollapse">
					<span class="icon-filter icon-medium text-muted qtr-margin-right toggle"></span>
					<span class="text-large text-muted toggle" [innerText]="'_VisualFilters_' | i18n"></span>
					<span class="qtr-padding-left icon-small text-muted toggle"
						[ngClass]="{
							'icon-chevron-up': !filterCollapse,
							'icon-chevron-down': filterCollapse
						}">
					</span>
				</div>
			</div>
		</ng-template>
	</cui-tabs>
</div>

<ng-template #assetsContent>
	<div class="flex flex-fill flex-fluid"
		*ngIf="!filterCollapse && !status.isLoading">
		<ng-container *ngFor="let filter of filters; index as i">
			<div *ngIf="!filter.loading && filter.seriesData.length"
				attr.id="AssetsSelectVisualFilter-{{ filter.key }}"
				attr.data-auto-id="AssetsSelectVisualFilter-{{ filter.key }}"
				[ngClass]="{
					'filter__selected': filter.selected,
					'filter__not-selected': !filter.selected
				}"
				class="panel flex-center flex-fill filter">
				<div class="base-margin-bottom">
					<div *ngIf="filter.template">
						<ng-container *ngTemplateOutlet="filter.template; context: { filter: filter }"></ng-container>
					</div>
				</div>
				<div class="filter__title text-muted text-large" [innerText]="filter.title"></div>
			</div>
			<div *ngIf="filter.loading" class="base-margin-bottom">
				<cui-spinner></cui-spinner>
			</div>
		</ng-container>
	</div>
	<div class="divider no-margin-top qtr-margin-bottom" *ngIf="!filterCollapse && !status.isLoading && pagination"></div>
	<ng-container *ngIf="filtered">
		<ng-container *ngTemplateOutlet="filterBar"></ng-container>
		<div class="divider qtr-margin-top"></div>
	</ng-container>
	<div>
		<div>
			<ng-container *ngIf="!status.isLoading && pagination">
				<ng-container *ngTemplateOutlet="titleBar"></ng-container>
			</ng-container>
			<div class="divider qtr-margin-top" *ngIf="!status.isLoading && pagination"></div>
			<ng-container *ngTemplateOutlet="tableAssets"></ng-container>
			<div *ngIf="pagination && pagination.total" class="base-margin-top">
				<cui-pager [page]="pagination.page - 1"
					[limit]="pagination.rows"
					[totalItems]="pagination.total || 0"
					(onPageChanged)="onPageChanged($event)">
				</cui-pager>
			</div>
		</div>
		<div *ngIf="status.inventoryLoading">
			<cui-spinner></cui-spinner>
		</div>
		<div *ngIf="!inventory.length && !status.inventoryLoading">
			<div class="text-center dbl-margin-top dbl-margin-bottom">
				<div>
					<span class="text-muted text-xlarge"
						[innerText]="'_NoResultsFound_' | i18n"
						data-auto-id="NoResultsFoundTxt" >
					</span>
				</div>
				<div *ngIf="filtered">
					<a (click)="clearFilters()"
						class="text-lowercase"
						data-auto-id="NoResultsClearAll"
						[innerText]="'_ClearAll_' | i18n">
					</a>
				</div>
			</div>
		</div>
	</div>
</ng-template>

<ng-template #titleBar>
	<div class="row">
		<div class="col-md-9 flex flex-fill">
			<div class="flex-center-vertical">
				<span [innerText]="'_Assets_' | i18n" class="text-large" *ngIf="!status.isLoading"></span>
				<span *ngIf="!status.isLoading && pagination && pagination.total" [innerText]="'_ShowingXofYAssets_' | i18n:paginationCount:pagination.total"
					class="qtr-margin-left text-small text-muted"
					data-auto-id="ShowingAssetsCount">
				</span>
				<span *ngIf="selected > 0">
					<span class="text-small text-muted qtr-margin-left qtr-margin-right">|</span>
					<span [innerText]="'_XSelected_' | i18n:selected"
						class="text-bold text-small text-muted" data-auto-id="TotalSelectedCount">
					</span>
				</span>
			</div>
		</div>
		<div class="col-md-3">
			<div class="flex flex-fluid flex-right">
				<div class="flex-fill form-group input--compressed input--icon half-margin-right">
					<form *ngIf="searchForm" [formGroup]="searchForm" novalidate>
						<div class="form-group__text">
							<input id="searchInput"
								attr.data-auto-id="SearchInput"
								type="text"
								#searchInput
								[maxlength]="searchOptions.max"
								[pattern]="searchOptions.pattern"
								formControlName="search"
								placeholder="{{ '_Search_' | i18n }} {{ options?.title }}"
								ngDefaultControl>
							<button type="button" class="link">
								<span class="icon-search"></span>
							</button>
						</div>
					</form>
				</div>
				<div class="btn-group btn-group--square half-margin-right">
					<button data-auto-id="list-view-btn" class="btn btn--small btn--gray-ghost" [ngClass]="{ 'selected': view == 'list' }" (click)="selectView('list')">
						<span class="icon-list-view"></span>
					</button>
					<button data-auto-id="grid-view-btn" class="btn btn--small btn--gray-ghost" [ngClass]="{ 'selected': view == 'grid' }" (click)="selectView('grid')">
						<span class="icon-grid-view"></span>
					</button>
				</div>
				<cui-dropdown [actions]="dropdownActions"
					position="left"
					icon="icon-more icon-medium text-muted rotate-90">
				</cui-dropdown>
			</div>
		</div>
	</div>
</ng-template>

<ng-template #tableAssets>
	<div class="responsive-table" *ngIf="assetsTable && inventory.length && (!view || view == 'list')">
		<table class="table table--selectable table--compressed table--wrap table--lined table--hover" data-auto-id="AssetsTable">
				<thead data-auto-id="AssetsTableHeader">
					<tr>
						<th>
							<label class="checkbox">
								<input type="checkbox"
									[checked]="allAssetsSelected"
									(click)="onAllSelect(!allAssetsSelected)"
									data-auto-id="AllAssetSelect" />
								<span class="checkbox__input"
									data-auto-id="AllAssetSelectCheckbox">
								</span>
							</label>
						</th>
						<th attr.data-auto-id="InventoryHeader-{{ column.name }}" *ngFor="let column of assetsTable.columns"
							[ngClass]="{ 'sortable': column.sortable, 'sorted': column.sorting }"
							(click)="onColumnSort(column)">
							<span [innerText]="column.name"></span>
							<span *ngIf="column.sortable && column.sorting"
								class="qtr-margin-left"
								[ngClass]="{
									'icon-chevron-up': column.sortDirection === 'asc',
									'icon-chevron-down': column.sortDirection === 'desc'
								}">
							</span>
						</th>
					</tr>
				</thead>
				<tbody data-auto-id="AssetsTableBody">
					<tr *ngFor="let item of inventory"
						attr.data-auto-id="InventoryItem-{{ item.data.serialNumber }}"
						(click)="onRowSelect(item)"
						[ngClass]="{ 'active': item.details }">
						<td (click)="$event.stopPropagation();"
							attr.data-auto-id="InventoryItemSelectTD-{{ item.data.serialNumber }}">
							<label class="checkbox">
								<input type="checkbox"
									[checked]="item.selected"
									(click)="onItemSelect(item)"
									attr.data-auto-id="InventoryItemSelect-{{ item.data.serialNumber }}" />
								<span class="checkbox__input"
									attr.data-auto-id="InventoryItemCheckbox-{{ item.data.serialNumber }}">
								</span>
							</label>
						</td>
						<td *ngFor="let column of assetsTable.columns"
							[ngStyle]="{ 'width': column.width }"
							attr.data-auto-id="InventoryItemClickHandler-{{ item.data.serialNumber }}"
							(click)="column.click ? $event.stopPropagation() : null">
							<ng-container *ngIf="column.template">
								<ng-container *ngTemplateOutlet="column.template; context: { celldata: item.data, element: item.element, actions: item.actions }"></ng-container>
							</ng-container>
							<ng-container *ngIf="!column.template">
								<span *ngIf="column.render" [innerHTML]="column.render(item.data)"
									attr.data-auto-id="{{ column.name }}-{{ item.data.serialNumber }}"></span>
								<span *ngIf="!column.render" [innerText]="item.data[column.key]"
									attr.data-auto-id="{ {column.name }}-{{ item.data.serialNumber }}"></span>
							</ng-container>
						</td>
					</tr>
				</tbody>
		</table>
	</div>
	<div class="panel panel--ltgray dbl-padding-right dbl-padding-left" *ngIf="assetsTable && inventory.length && view == 'grid'">
		<div class="row">
			<div *ngFor="let item of inventory" class="col-md-2 half-margin-bottom half-margin-top flex">
				<ng-container *ngTemplateOutlet="cardTemplate; context: { item: item }"></ng-container>
			</div>
		</div>
	</div>
</ng-template>

<ng-template #cardTemplate let-item="item">
	<div class="card curved-corners container-fluid card-content"
		[ngClass]="{ 'card__selected': item.selected }"
		(click)="onItemSelect(item)" attr.data-auto-id="InventoryItem-{{ item.data?.serialNumber }}">
		<div class="card__header">
			<div class="card__title flex-center card-title-height">
				<a
					attr.data-auto-id="Device-{{ item.data?.serialNumber }}"
					class="text-large text-center"
					[innerText]="item.data.deviceName | truncate:true:20"
					(click)="onRowSelect(item); $event.stopPropagation();"
				></a>
			</div>
			<div class="flex-center text-center">
				<span *ngIf="item.data?.productName"
					[innerText]="item.data?.productName | truncate:true:20"
					attr.data-auto-id="ProductName-{{ item.data?.serialNumber }}">
				</span>
			</div>
			<div class="flex-center dbl-margin-top dbl-margin-bottom">
				<!-- ngIf's using literal values until source of image is confirmed -->
				<img *ngIf="false" attr.data-auto-id="DeviceImg-{{ item.data?.serialNumber }}" [src]="" alt=""/>
				<span *ngIf="true" attr.data-auto-id="DeviceImg-{{ item.data?.serialNumber }}"
					class="col-md-6 text-muted text-center text-uppercase text-wrap-normal"
					[innerText]="'_NoPhotoAvailable_' | i18n">
				</span>
			</div>
		</div>
		<div class="card__body text-small dbl-margin-bottom">
			<div class="row qtr-margin-top">
				<div class="col-md-6 text-right text-dkgray-4" [innerText]="'_IPAddress_' | i18n"></div>
				<div class="col-md-6" [innerText]="(item.data?.ipAddress || ('_NA_' | i18n)) | truncate:true:15:'...'" attr.data-auto-id="IPAddress-{{ item.data?.serialNumber }}"></div>
			</div>
			<div class="row qtr-margin-top">
				<div class="col-md-6 text-right text-dkgray-4" [innerText]="'_LastScan_' | i18n"></div>
				<div class="col-md-6" [innerText]="(item.data?.lastScan ? (item.data.lastScan | fromNow) : ('_Never_' | i18n)) | truncate:true:15:'...'" attr.data-auto-id="LastScan-{{ item.data?.serialNumber }}"></div>
			</div>
			<div class="row qtr-margin-top">
				<div class="col-md-6 text-right text-dkgray-4" [innerText]="'_SerialNumber_' | i18n"></div>
				<div class="col-md-6" [innerText]="(item.data?.serialNumber || ('_NA_' | i18n)) | truncate:true:15:'...'" attr.data-auto-id="SerialNumber-{{ item.data?.serialNumber }}"></div>
			</div>
			<div class="row qtr-margin-top">
				<div class="col-md-6 text-right text-dkgray-4" [innerText]="'_Software_' | i18n"></div>
				<div class="col-md-6">
					<ng-container
						*ngTemplateOutlet="(item.data?.osType || item.data?.osVersion) ? hasSoftware : NA;
							context: {type: item.data.osType, version: item.data.osVersion, serialNumber: item.data.serialNumber}">
					</ng-container>
				</div>
			</div>
			<div class="row qtr-margin-top">
				<div class="col-md-6 text-right text-dkgray-4" [innerText]="'_Role_' | i18n"></div>
				<div class="col-md-6" [innerText]="(item.data?.role || ('_NA_' | i18n)) | truncate:true:15:'...'" attr.data-auto-id="Role-{{ item.data?.serialNumber }}"></div>
			</div>
		</div>
		<div class="card__footer justify-content-between override-selected-z">
			<div>
				<span *ngIf="item.data?.criticalAdvisories" class="badge-wrapper base-margin-right">
					<span tabindex="0"
						data-balloon-indigo [attr.data-balloon]="'_CriticalAdvisories_' | i18n"
						data-balloon-pos="down"
						attr.data-auto-id="AdvisoryIcon-{{ item.data?.serialNumber }}">
						<span class="icon-alert icon-small text-dkgray-4 text-noselect"></span>
					</span>
					<span class="badge badge--tiny badge--danger"
						[innerText]="item.data?.criticalAdvisories"
						attr.data-auto-id="AdvisoryCount-{{ item.data?.serialNumber }}">
					</span>
				</span>
				<span *ngIf="item.data?.supportCovered" class="badge-wrapper">
					<span tabindex="0"
						data-balloon-indigo [attr.data-balloon]="'_SupportCoverage_' | i18n"
						data-balloon-pos="down"
						attr.data-auto-id="CoveredIcon-{{ item.data?.serialNumber }}">
						<span class="icon-headset icon-small text-dkgray-4"></span>
					</span>
					<span class="badge badge--tiny badge--success icon-check"></span>
				</span>
			</div>
			<div *ngIf="item.actions.length">
				<cui-dropdown
					attr.data-auto-id="InventoryItem-{{ item.data?.serialNumber }}-dropdown"
					(click)="$event.stopPropagation()"
					[actions]="item.actions"
					icon="icon-more icon-small text-muted rotate-90">
				</cui-dropdown>
			</div>
		</div>
	</div>
</ng-template>

<ng-template #NA let-type="type" let-verison="version" let-serialNumber="serialNumber">
	<span [innerText]="'_NA_' | i18n" attr.data-auto-id="Software-{{ serialNumber }}"></span>
</ng-template>

<ng-template #hasSoftware let-type="type" let-version="version" let-serialNumber="serialNumber">
	<div attr.data-auto-id="Software-{{ serialNumber }}">
		<span *ngIf="type" innerText="{{type}} "></span>
		<span *ngIf="version" [innerText]="version"></span>
	</div>
</ng-template>

<ng-template #supportCoverage let-celldata="celldata">
	<div class="flex flex-fill flex-center">
		<span
			*ngIf="celldata?.supportCovered" class="icon-check-outline icon-small text--success"
			data-auto-id="SupportCoveredIcon">
		</span>
	</div>
</ng-template>

<ng-template #criticalAdvisories let-celldata="celldata">
	<div *ngIf="celldata.criticalAdvisories"
		class="flex flex-fill flex-center">
		<span class="label label--circle label--danger"
			[innerText]="celldata.criticalAdvisories"
			data-auto-id="CriticalAdvisoriesIcon">
		</span>
	</div>
</ng-template>

<ng-template #deviceTemplate let-celldata="celldata" let-element="element">
	<span class="qtr-margin-right" *ngIf="element && getProductIcon(element)">
		<img alt="{{ '_AssetIcon_' | i18n }}"
			class="icon-asset"
			attr.data-auto-id="DeviceIcon-{{ celldata?.deviceName }}"
			src="assets/img/assets/device-{{ getProductIcon(element) }}.svg">
	</span>
	<span [innerText]="celldata.deviceName | truncate:true:50"
		attr.data-auto-id="Device-{{celldata.serialNumber}}">
	</span>
</ng-template>

<ng-template #actionsTemplate let-celldata="celldata" let-actions="actions">
	<cui-dropdown *ngIf="actions.length"
		[actions]="actions"
		position="left"
		icon="icon-more icon-medium text-muted rotate-90">
	</cui-dropdown>
</ng-template>

<ng-template #filterBar>
	<div class="row">
		<div class="col-md-1 flex flex-center-vertical">
			<span class="text-bold text-uppercase half-padding-right" [innerText]="'_Filtered_' | i18n"></span>
		</div>
		<div class="col-md-10">
			<ng-container *ngFor="let selectedSubfilter of selectedSubfilters">
				<span class="label label--dkgray text-large"
					(click)="onSubfilterSelect(selectedSubfilter.subfilter.filter, selectedSubfilter.filter)"
					attr.data-auto-id="FilterTag-{{ selectedSubfilter.subfilter.filter }}">
					<span [innerText]="selectedSubfilter.subfilter.label"></span>
					<span class="icon-close"></span>
				</span>
			</ng-container>
		</div>
		<div class="col-md-1 text-center text-right">
			<a (click)="clearFilters()"
				class="text-lowercase"
				[innerText]="'_ClearAll_' | i18n"
				data-auto-id="FilterBarClearAllFilters">
			</a>
		</div>
	</div>
</ng-template>

<!-- Templates for our Visual Filters for the Assets Tab -->
<ng-template #totalFilter let-filter="filter">
	<div class="text-huge flex-center dbl-padding-left dbl-padding-right"
		(click)="clearFilters()"
		data-auto-id="TotalVisualFilter"
		[innerText]="filter.seriesData[0].value || 0">
	</div>
</ng-template>

<ng-template #bubbleChartFilter let-filter="filter">
	<bubble-chart [seriesData]="filter.seriesData"
		(subfilter)="onSubfilterSelect($event.filter, filter)">
	</bubble-chart>
</ng-template>

<ng-template #pieChartFilter let-filter="filter">
	<pie-chart [seriesData]="filter.seriesData"
		(subfilter)="onSubfilterSelect($event.filter, filter)">
	</pie-chart>
</ng-template>

<ng-template #barChartFilter let-filter="filter">
	<bar-chart [seriesData]="filter.seriesData" [width]="350"
		(subfilter)="onSubfilterSelect($event.filter, filter)">
	</bar-chart>
</ng-template>
